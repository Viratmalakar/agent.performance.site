<!DOCTYPE html>
<html>
<head>
<title>Agent Performance</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
background:linear-gradient(135deg,#e6fff1,#ffffff);
font-family:Segoe UI;
}

.box{
background:white;
padding:25px;
border-radius:12px;
max-width:1200px;
margin:auto;
box-shadow:0 10px 30px rgba(22,163,74,0.25);
}

input{margin:5px;}

button{
background:linear-gradient(45deg,#16a34a,#22c55e);
color:white;border:none;
padding:10px 18px;
border-radius:20px;
margin:5px;
font-weight:bold;
cursor:pointer;
}

table{
width:100%;
border-collapse:collapse;
margin-top:20px;
}

th{background:#16a34a;color:white;padding:10px;}
td{padding:8px;border:1px solid #ddd;}
tr:hover{background:#dcfce7;}

#loading{
position:fixed;top:0;left:0;width:100%;height:100%;
background:white;display:none;
align-items:center;justify-content:center;
font-size:32px;color:#16a34a;font-weight:bold;
z-index:9999;
}

footer{text-align:center;margin-top:20px;color:#16a34a;font-weight:bold;}
</style>
</head>
<body>

<div id="loading">Generating Report...</div>

<div class="box">
<h2>Agent Performance Dashboard</h2>

<b>Upload Agent Performance Report</b><br>
<input type="file" id="agent"><br><br>

<b>Upload CDR Report</b><br>
<input type="file" id="cdr"><br><br>

<button onclick="generate()">Generate</button>
<button id="exportBtn" onclick="exportExcel()" style="display:none">Export</button>
<button id="copyBtn" onclick="copyImage()" style="display:none">Copy Table Image</button>
<button id="resetBtn" onclick="resetAll()" style="display:none">Reset</button>

<div id="table"></div>
</div>

<footer>Website created by Chandan Malakar</footer>

<script>
let report=[];

function generate(){
loading.style.display="flex";
let f=new FormData();
f.append("agent",agent.files[0]);
f.append("cdr",cdr.files[0]);

fetch("/process",{method:"POST",body:f})
.then(r=>r.json())
.then(d=>{
report=d;
draw(d);
loading.style.display="none";
exportBtn.style.display="inline";
copyBtn.style.display="inline";
resetBtn.style.display="inline";
});
}

function draw(d){
let h="<table id='rtable'><tr>";
Object.keys(d[0]).forEach(k=>h+="<th>"+k+"</th>");
h+="</tr>";
d.forEach(r=>{
h+="<tr>";
Object.values(r).forEach(v=>h+="<td>"+v+"</td>");
h+="</tr>";
});
h+="</table>";
table.innerHTML=h;
}

function exportExcel(){
fetch("/export",{method:"POST",body:JSON.stringify(report)})
.then(r=>r.blob())
.then(b=>{
let a=document.createElement("a");
a.href=URL.createObjectURL(b);
a.download="report.xlsx";
a.click();
});
}

function copyImage(){
html2canvas(document.getElementById("rtable")).then(canvas=>{
canvas.toBlob(b=>{
navigator.clipboard.write([new ClipboardItem({"image/png":b})]);
alert("Table image copied");
});
});
}

function resetAll(){
agent.value="";
cdr.value="";
table.innerHTML="";
report=[];
exportBtn.style.display="none";
copyBtn.style.display="none";
resetBtn.style.display="none";
}
</script>

</body>
</html>
